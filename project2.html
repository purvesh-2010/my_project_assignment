<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker - Project 2 </title>
    <style>
        :root {
            --bg-main: #02020a;
            --bg-panel: #050509;
            --bg-card: #080816;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-income: #10b981;
            --accent-expense: #ef4444;
            --accent-filter: #f97316;
            --border: #1e293b;
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-main), #1e1b4b);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, var(--accent-income), var(--accent-expense));
            -webkit-backhover-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .income {
            color: var(--accent-income);
        }

        .expense {
            color: var(--accent-expense);
        }

        .balance {
            color: var(--accent-income);
        }

        .form-section,
        .filters,
        .charts {
            background: var(--bg-panel);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr 120px auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 20px;
        }

        input,
        select {
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1em;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-filter);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(45deg, var(--accent-income), #059669);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--accent-expense), #dc2626);
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 120px auto auto;
            gap: 15px;
            align-items: end;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-panel);
            font-weight: bold;
        }

        .income-row {
            border-left: 4px solid var(--accent-income);
        }

        .expense-row {
            border-left: 4px solid var(--accent-expense);
        }

        .action-btn {
            padding: 6px 12px;
            margin: 0 3px;
            font-size: 0.9em;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        canvas {
            width: 100%;
            height: 300px;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        @media (max-width: 768px) {

            .form-grid,
            .filter-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .empty {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 40px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-panel);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
        }

        .close {
            float: right;
            font-size: 2em;
            cursor: pointer;
            color: var(--text-secondary);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üíÄ Ghost Finance Tracker</h1>
            <p>Track your income & expenses like a spectral accountant</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value income" id="totalIncome">‚Çπ0.00</div>
                <div>Total Income</div>
            </div>
            <div class="stat-card">
                <div class="stat-value expense" id="totalExpense">‚Çπ0.00</div>
                <div>Total Expenses</div>
            </div>
            <div class="stat-card">
                <div class="stat-value balance" id="balance">‚Çπ0.00</div>
                <div>Current Balance</div>
            </div>
        </div>

        <div class="form-section">
            <div class="form-grid">
                <input type="text" id="description" placeholder="Description" maxlength="50">
                <input type="number" id="amount" placeholder="Amount" step="0.01" min="0">
                <select id="type">
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                </select>
                <select id="category"></select>
                <input type="date" id="date">
                <button onclick="addTransaction()">‚ûï Add</button>
            </div>
        </div>

        <div class="filters">
            <div class="filter-grid">
                <input type="date" id="filterStart">
                <input type="date" id="filterEnd">
                <select id="filterCategory">
                    <option value="">All Categories</option>
                </select>
                <select id="filterType">
                    <option value="">All Types</option>
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                </select>
                <button onclick="filterTransactions()">üîç Filter</button>
                <button onclick="exportCSV()">üìä Export</button>
                <button onclick="clearFilters()">üßπ Clear</button>
            </div>
        </div>

        <div class="charts">
            <h3>üìà Visual Analytics</h3>
            <div class="charts-grid">
                <div>
                    <h4>Category Breakdown (Pie)</h4>
                    <canvas id="pieChart"></canvas>
                </div>
                <div>
                    <h4>Income vs Expense (Bar)</h4>
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>

        <div id="transactions">
            <h3>üí∏ Recent Transactions</h3>
            <table id="transactionTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Type</th>
                        <th>Category</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="transactionBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>Edit Transaction</h3>
            <div class="form-grid">
                <input type="text" id="editDescription" placeholder="Description">
                <input type="number" id="editAmount" placeholder="Amount" step="0.01" min="0">
                <select id="editType">
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                </select>
                <select id="editCategory"></select>
                <input type="date" id="editDate">
                <button onclick="saveEdit()">üíæ Save</button>
            </div>
        </div>
    </div>

    <script>
        // Categories array (consistent structure)
        const categories = ['Food', 'Transport', 'Entertainment', 'Shopping', 'Salary', 'Freelance', 'Bills', 'Other'];

        // Data structure: {id, type, amount, category, date, description}
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let editingId = null;
        let currentFilter = { start: '', end: '', category: '', type: '' };

        // INR formatter
        const formatINR = (num) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(num);

        // Initialize
        function init() {
            populateCategories();
            renderTransactions();
            updateStats();
            renderCharts();
            document.getElementById('date').valueAsDate = new Date();
        }

        // Populate category dropdowns
        function populateCategories() {
            const cats = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('category').innerHTML = cats;
            document.getElementById('editCategory').innerHTML = cats;
            document.getElementById('filterCategory').innerHTML = `<option value="">All Categories</option>` + cats;
        }

        // Add transaction with validation
        function addTransaction() {
            const desc = document.getElementById('description').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);
            const type = document.getElementById('type').value;
            const cat = document.getElementById('category').value;
            const date = document.getElementById('date').value;

            if (!desc || isNaN(amount) || amount <= 0 || !cat || !date) {
                alert('Please fill all fields correctly');
                return;
            }

            const transaction = {
                id: Date.now(),
                type, amount, category: cat, date,
                description: desc
            };
            transactions.unshift(transaction);
            saveData();
            renderTransactions();
            updateStats();
            renderCharts();
            clearForm();
        }

        // Render transactions table with filters
        function renderTransactions() {
            const tbody = document.getElementById('transactionBody');
            let filtered = applyFilters(transactions);

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty">No transactions match your filters</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(t => `
                <tr class="${t.type}-row">
                    <td>${new Date(t.date).toLocaleDateString('en-IN')}</td>
                    <td>${t.description}</td>
                    <td>${formatINR(t.amount)}</td>
                    <td>${t.type.toUpperCase()}</td>
                    <td>${t.category}</td>
                    <td>
                        <button class="action-btn" onclick="editTransaction(${t.id})">‚úèÔ∏è</button>
                        <button class="action-btn btn-danger" onclick="deleteTransaction(${t.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        // Filter logic using Date objects
        function applyFilters(data) {
            return data.filter(t => {
                const transDate = new Date(t.date);
                const startOk = !currentFilter.start || transDate >= new Date(currentFilter.start);
                const endOk = !currentFilter.end || transDate <= new Date(currentFilter.end);
                const catOk = !currentFilter.category || t.category === currentFilter.category;
                const typeOk = !currentFilter.type || t.type === currentFilter.type;
                return startOk && endOk && catOk && typeOk;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Filter button handler
        function filterTransactions() {
            currentFilter = {
                start: document.getElementById('filterStart').value,
                end: document.getElementById('filterEnd').value,
                category: document.getElementById('filterCategory').value,
                type: document.getElementById('filterType').value
            };
            renderTransactions();
            renderCharts();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('filterStart').value = '';
            document.getElementById('filterEnd').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterType').value = '';
            currentFilter = { start: '', end: '', category: '', type: '' };
            renderTransactions();
            renderCharts();
        }

        // Stats using reduce()
        function updateStats() {
            const filtered = applyFilters(transactions);
            const income = filtered.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = filtered.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

            document.getElementById('totalIncome').textContent = formatINR(income);
            document.getElementById('totalExpense').textContent = formatINR(expense);
            document.getElementById('balance').textContent = formatINR(income - expense);
        }

        // Canvas Pie Chart - category breakdown
        function renderPieChart() {
            const canvas = document.getElementById('pieChart');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            const filtered = applyFilters(transactions);
            const expenseByCat = {};
            filtered.filter(t => t.type === 'expense').forEach(t => {
                expenseByCat[t.category] = (expenseByCat[t.category] || 0) + t.amount;
            });

            const total = Object.values(expenseByCat).reduce((a, b) => a + b, 0);
            if (total === 0) {
                ctx.fillStyle = '#334155';
                ctx.textAlign = 'center';
                ctx.font = '20px Segoe UI';
                ctx.fillText('No Expenses', canvas.width / 2, canvas.height / 2);
                return;
            }

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.7;
            let startAngle = 0;

            Object.entries(expenseByCat).forEach(([cat, amount], i) => {
                const sliceAngle = (amount / total) * 2 * Math.PI;
                ctx.fillStyle = `hsl(${i * 40}, 70%, 50%)`;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.closePath();
                ctx.fill();
                startAngle += sliceAngle;
            });
        }

        // ‚úÖ FIXED Bar Chart - Income vs Expense
        function renderBarChart() {
            const canvas = document.getElementById('barChart');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            const filtered = applyFilters(transactions);
            const income = filtered.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = filtered.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const max = Math.max(income, expense, 1);

            const barWidth = canvas.width / 3;
            const barHeight = canvas.height * 0.7;

            // FIXED: Get CSS variables properly
            const styles = getComputedStyle(document.documentElement);
            const accentIncome = styles.getPropertyValue('--accent-income').trim();
            const accentExpense = styles.getPropertyValue('--accent-expense').trim();
            const textPrimary = styles.getPropertyValue('--text-primary').trim();

            // Income bar (FIXED)
            ctx.fillStyle = accentIncome || '#10b981';
            ctx.fillRect(20, canvas.height - (income / max * barHeight) - 20, barWidth - 20, income / max * barHeight);

            // Expense bar (FIXED)
            ctx.fillStyle = accentExpense || '#ef4444';
            ctx.fillRect(canvas.width / 2 + 20, canvas.height - (expense / max * barHeight) - 20, barWidth - 20, expense / max * barHeight);

            // Labels (FIXED)
            ctx.fillStyle = textPrimary || '#e2e8f0';
            ctx.font = 'bold 16px Segoe UI';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(formatINR(income), 20 + barWidth / 2 - 10, canvas.height - 35);
            ctx.fillText(formatINR(expense), canvas.width / 2 + 20 + barWidth / 2 - 10, canvas.height - 35);
            ctx.fillText('Income', 20 + barWidth / 2 - 10, 30);
            ctx.fillText('Expense', canvas.width / 2 + 20 + barWidth / 2 - 10, 30);
        }

        // Render both charts
        function renderCharts() {
            renderPieChart();
            renderBarChart();
            updateStats();
        }

        // Edit transaction
        function editTransaction(id) {
            const trans = transactions.find(t => t.id === id);
            editingId = id;
            document.getElementById('editDescription').value = trans.description;
            document.getElementById('editAmount').value = trans.amount;
            document.getElementById('editType').value = trans.type;
            document.getElementById('editCategory').value = trans.category;
            document.getElementById('editDate').value = trans.date;
            document.getElementById('editModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            editingId = null;
        }

        function saveEdit() {
            if (!editingId) return;
            const transIndex = transactions.findIndex(t => t.id === editingId);
            transactions[transIndex] = {
                ...transactions[transIndex],
                description: document.getElementById('editDescription').value,
                amount: parseFloat(document.getElementById('editAmount').value),
                type: document.getElementById('editType').value,
                category: document.getElementById('editCategory').value,
                date: document.getElementById('editDate').value
            };
            saveData();
            renderTransactions();
            renderCharts();
            closeModal();
        }

        // Delete transaction
        function deleteTransaction(id) {
            if (confirm('Delete this transaction?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                renderTransactions();
                renderCharts();
            }
        }

        // Export CSV
        function exportCSV() {
            const filtered = applyFilters(transactions);
            if (filtered.length === 0) {
                alert('No transactions to export');
                return;
            }
            let csv = 'Date,Description,Amount,Type,Category\n';
            filtered.forEach(t => {
                csv += `"${new Date(t.date).toLocaleDateString('en-IN')}", "${t.description}", ${t.amount}, ${t.type}, "${t.category}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expenses_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // LocalStorage persistence
        function saveData() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }

        function clearForm() {
            document.getElementById('description').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('category').value = categories[0];
            document.getElementById('date').valueAsDate = new Date();
        }

        // Event Listeners
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) closeModal();
        });

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>